# 更新日志 (Changelog)

本项目所有值得注意的变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [0.1.0] - 2024-02-21

### 新增
- 初始化项目基础结构
- 创建基本目录架构
- 设置conda环境配置
- 添加项目文档
- 配置示例文件
- 添加loguru日志系统
  - 支持控制台彩色输出
  - 支持文件日志按大小轮转（1MB）
  - 支持日志文件保留时间（7天）
  - 支持日志文件压缩
  - 支持多环境配置（dev/prod等）
  - 添加完整的测试用例
- 创建FastAPI应用入口
- 添加依赖
  - PyYAML 6.0.1 用于配置文件解析
- 添加配置加载器使用示例 (`examples/config_demo.py`)
  - 演示如何通过全局 `config` 获取配置项
  - 演示配置自动重载功能
- 编写主应用入口 (`app/main.py`)，集成 `config` 和 `logger`，支持根据配置自动启动 FastAPI 服务

### 变更
- 项目名称更改为 Lithium
- 虚拟环境名称更改为 lithium
- 数据库文件名更改为 lithium.db
- 优化日志配置结构，改用更清晰的层次结构
- 将日志模块移动到 utils 目录
- 简化配置加载逻辑，移除独立的配置模块

### 修复
- 无

### 移除
- 移除独立的配置加载模块

### 安全
- 无

## [2024-01-20]

### 改进
- 优化了日志系统的链路追踪功能
  - 使用`contextvars`重构了`trace_id`的存储机制，确保线程安全
  - 简化了`trace_id`格式，使用UUID的前8位作为追踪ID
  - 新增`TracedLogger`类，自动集成追踪功能
  - 添加了`TraceIDFilter`过滤器，自动为每条日志添加trace_id
  - 优化了日志格式，使用竖线分隔各个字段，提高可读性
  - 为所有日志处理器启用了异步写入功能
  - 完善了日志配置的错误处理机制
  - 增强了日志格式化功能，完全兼容loguru的格式化API
  - 改进了日志配置文件中的格式定义，确保trace_id正确显示
  - 为控制台日志添加了彩色显示支持，使trace_id更醒目
- 更新了日志使用示例（examples/logger_demo.py）
  - 添加了链路追踪功能的完整示例
  - 新增了上下文日志记录的示例
  - 改进了异步日志记录的示例
  - 优化了示例代码的组织结构
  - 简化了示例代码，使其更加清晰和易懂
  - 改进了结构化日志的记录方式，使用更优雅的格式化方法

### 修复
- 修复了`TracedLogger`不支持loguru风格格式化的问题
- 修复了上下文管理相关的类型错误
- 修复了trace_id在日志中不显示的问题
- 修复了trace_id为None时的格式化问题

### 移除
- 无

### 安全
- 无

## [2024-04-28]

### 新增
- 添加启动脚本 (`scripts/run_main.bat`)，通过设置 `PYTHONPATH` 启动主应用
- 完善主应用入口 (`app/main.py`)，集成配置加载和日志记录，支持根据配置动态启动服务

### 变更
- 将配置加载器模块移动到 `app/config` 目录，并更新导入路径

### 修复
- 无

### 移除
- 无

### 安全
- 无

## [2024-04-29]

### 改进
- 调整 `TracedLogger` 中的 `opt(depth)` 参数为 `depth=2`，使日志中 `name:function:line` 字段准确显示真实调用位置

### 修复
- 无

### 移除
- 无

### 安全
- 无

### 改进
- 使用 `watchdog` 替换轮询机制监视配置文件，只对指定的 `config_{env}.yml` 文件的修改触发重新加载

### 新增
- 添加 `watchdog` 依赖用于高效地监视配置文件变化

### 新增
- 在 `app/core/agents` 下创建 `agents` 包
- 添加自然语言转SQL智能体 `Nl2SqlAgent`：
  - 简易规则将中文自然语言查询转为SQL
  - 通过 SQLAlchemy 执行生成的 SQL 并返回结果列表

## [2024-03-21]

### 新增
- 添加了 `examples/agent_demo.py` 示例文件，展示如何使用 BaseAgent
- 在配置文件中添加了 LLM 相关配置项

### 技术细节
- 示例代码展示了如何从配置文件获取 LLM 参数
- 展示了流式和非流式响应的使用方法
- 配置文件新增 `llm` 部分，包含 API 密钥、基础 URL、模型选择等配置

### 改进
- 重构了 ModelConfig 类，将 api_key 和 api_base 从 BaseAgent 移至 ModelConfig
- 更新了导入语句，使用绝对路径替代相对路径
- 简化了 BaseAgent 的构造函数，移除了冗余参数
- 优化了 BaseAgent 中的参数传递，排除了不需要传递给 API 的配置项

### 技术细节
- ModelConfig 新增 api_key（必填）和 api_base（可选）字段
- 使用 pydantic.Field 为新字段添加了描述信息
- 更新了 BaseAgent 的参数验证和处理逻辑
- 所有导入路径更新为绝对路径格式

### 改进
- 优化了 `examples/agent_demo.py` 的代码结构：
  - 利用 Python 3.12 特性简化异步处理
  - 添加了完整的类型注解
  - 抽取独立的测试函数
  - 改进了代码组织和文档

### 改进
- 优化了 BaseAgent 的 API 客户端实现：
  - 使用 httpx.AsyncClient 作为底层客户端
  - 改进了资源管理和清理机制
  - 添加了完整的错误处理
- 优化了示例代码的资源管理：
  - 添加了客户端资源清理
  - 改进了错误处理机制
  - 完善了类型提示和文档

### 修复
- 修复了 httpx 客户端配置问题：
  - 添加了正确的连接池配置
  - 设置了合理的连接限制
  - 优化了超时设置

### 修复
- 修复了流式响应中消息历史记录问题：
  - 在流式输出时收集完整响应内容
  - 确保响应结束后将内容添加到消息历史
  - 保持了消息历史的完整性和一致性

### 改进
- 优化了流式响应的处理机制：
  - 调整处理顺序，确保响应实时性
  - 优化内容存储方式，提高性能
  - 改进字符串拼接策略


